# 模块4: 风格管理系统
import json
import os
import re
import time
import copy
import random
from pathlib import Path
from typing import Dict, List, Any, Optional, Tuple
import logging
from dataclasses import dataclass
from enum import Enum
import numpy as np
from 模块2_配置管理 import 获取配置管理器
from 模块3_网络学习引擎 import 获取网络学习引擎

class 风格类型(Enum):
    热血战斗风 = "热血战斗风"
    虐心言情风 = "虐心言情风" 
    悬疑推理风 = "悬疑推理风"
    黑暗幻想风 = "黑暗幻想风"
    轻松搞笑风 = "轻松搞笑风"
    现实写实风 = "现实写实风"
    史诗奇幻风 = "史诗奇幻风"
    硬核科幻风 = "硬核科幻风"
    唯美古风 = "唯美古风"
    商战职场风 = "商战职场风"
    恐怖惊悚风 = "恐怖惊悚风"
    日常温馨风 = "日常温馨风"
    仙侠修真风 = "仙侠修真风"
    西方奇幻风 = "西方奇幻风"
    历史架空风 = "历史架空风"

@dataclass
class 风格参数:
    """风格参数数据结构"""
    名称: str
    类型: 风格类型
    描述: str
    词汇偏好: List[str]
    句式特点: Dict[str, float]  # 句式类型 -> 权重
    情感基调: Dict[str, float]  # 情感 -> 强度
    节奏控制: Dict[str, float]  # 节奏参数
    特殊规则: List[str]
    作者影响: Dict[str, float]  # 作者风格影响权重
    创建时间: float
    修改时间: float
    使用次数: int
    用户评分: float
    融合度: float = 1.0  # 原始风格为1.0，融合风格<1.0

class 风格分析器:
    """风格特征分析器"""
    def __init__(self):
        self.配置管理器 = 获取配置管理器()
        self.日志器 = logging.getLogger('风格分析器')
        
        # 风格特征库
        self.句式模式库 = self.初始化句式模式库()
        self.情感词汇库 = self.初始化情感词汇库()
        self.节奏特征库 = self.初始化节奏特征库()
        self.作者风格库 = self.初始化作者风格库()
    
    def 初始化句式模式库(self) -> Dict[str, List[str]]:
        """初始化句式模式库"""
        return {
            "短句": ["。", "！", "？"],
            "长句": ["，", "；", "："],
            "对话句": ["“", "”", "说道", "问道", "喊道"],
            "描写句": ["的", "地", "得", "着", "了", "过"],
            "心理句": ["想", "觉得", "认为", "意识到", "感觉"],
            "动作句": ["走", "跑", "跳", "打", "说", "看"]
        }
    
    def 初始化情感词汇库(self) -> Dict[str, List[str]]:
        """初始化情感词汇库"""
        return {
            "喜悦": ["高兴", "快乐", "欣喜", "兴奋", "幸福", "笑容"],
            "悲伤": ["伤心", "难过", "痛苦", "悲哀", "泪", "哭泣"],
            "愤怒": ["生气", "愤怒", "怒火", "愤慨", "暴怒", "咬牙切齿"],
            "恐惧": ["害怕", "恐惧", "惊慌", "恐怖", "胆战心惊", "毛骨悚然"],
            "惊讶": ["惊讶", "吃惊", "震惊", "意外", "没想到", "居然"],
            "爱慕": ["爱", "喜欢", "倾心", "爱慕", "钟情", "心动"],
            "憎恶": ["恨", "讨厌", "厌恶", "憎恨", "反感", "嫌弃"]
        }
    
    def 初始化节奏特征库(self) -> Dict[str, Dict[str, Any]]:
        """初始化节奏特征库"""
        return {
            "快节奏": {
                "平均句长": 15,
                "短句比例": 0.7,
                "动作动词密度": 0.3,
                "对话比例": 0.4
            },
            "慢节奏": {
                "平均句长": 25, 
                "短句比例": 0.3,
                "动作动词密度": 0.1,
                "对话比例": 0.2
            },
            "中节奏": {
                "平均句长": 20,
                "短句比例": 0.5,
                "动作动词密度": 0.2,
                "对话比例": 0.3
            }
        }
    
    def 初始化作者风格库(self) -> Dict[str, Dict[str, Any]]:
        """初始化知名作者风格库"""
        return {
            "金庸": {
                "风格类型": "武侠史诗",
                "特点": ["大气磅礴", "人物鲜明", "情节曲折", "历史厚重"],
                "句式偏好": ["长句", "描写句"],
                "情感基调": {"豪迈": 0.8, "悲壮": 0.6, "柔情": 0.4},
                "词汇特征": ["江湖", "武林", "侠客", "武功", "恩怨"]
            },
            "琼瑶": {
                "风格类型": "浪漫言情", 
                "特点": ["情感细腻", "对话优美", "情节虐心", "文艺气息"],
                "句式偏好": ["对话句", "心理句"],
                "情感基调": {"爱慕": 0.9, "悲伤": 0.7, "喜悦": 0.5},
                "词汇特征": ["爱情", "缘分", "泪水", "心痛", "永恒"]
            },
            "刘慈欣": {
                "风格类型": "硬核科幻",
                "特点": ["科学严谨", "想象宏大", "逻辑严密", "哲学思考"],
                "句式偏好": ["长句", "描写句"],
                "情感基调": {"惊讶": 0.7, "恐惧": 0.6, "沉思": 0.8},
                "词汇特征": ["宇宙", "科技", "文明", "时间", "维度"]
            },
            "江南": {
                "风格类型": "青春幻想",
                "特点": ["文笔华丽", "情感炽烈", "现代感强", "中西结合"],
                "句式偏好": ["心理句", "描写句"],
                "情感基调": {"悲伤": 0.8, "爱慕": 0.7, "愤怒": 0.6},
                "词汇特征": ["青春", "命运", "孤独", "王者", "史诗"]
            }
        }
    
    def 分析文本风格(self, 文本: str) -> Dict[str, Any]:
        """分析文本的风格特征"""
        if not 文本 or len(文本) < 100:
            return self.生成默认分析结果()
        
        分析结果 = {
            "句式分析": self.分析句式特征(文本),
            "情感分析": self.分析情感特征(文本),
            "节奏分析": self.分析节奏特征(文本),
            "词汇分析": self.分析词汇特征(文本),
            "整体风格": "未知"
        }
        
        # 判断整体风格
        分析结果["整体风格"] = self.判断整体风格(分析结果)
        
        return 分析结果
    
    def 分析句式特征(self, 文本: str) -> Dict[str, float]:
        """分析句式特征"""
        句子列表 = self.分割句子(文本)
        if not 句子列表:
            return {}
        
        特征统计 = {}
        总句子数 = len(句子列表)
        
        for 句式类型, 模式列表 in self.句式模式库.items():
            匹配数 = 0
            for 句子 in 句子列表:
                if any(模式 in 句子 for 模式 in 模式列表):
                    匹配数 += 1
            特征统计[句式类型] = 匹配数 / 总句子数
        
        return 特征统计
    
    def 分析情感特征(self, 文本: str) -> Dict[str, float]:
        """分析情感特征"""
        情感统计 = {}
        总词数 = len(文本)
        
        for 情感类型, 词汇列表 in self.情感词汇库.items():
            出现次数 = sum(文本.count(词汇) for 词汇 in 词汇列表)
            情感统计[情感类型] = 出现次数 / max(总词数 / 100, 1)  # 每百字出现次数
        
        return 情感统计
    
    def 分析节奏特征(self, 文本: str) -> Dict[str, float]:
        """分析节奏特征"""
        句子列表 = self.分割句子(文本)
        if not 句子列表:
            return {}
        
        # 计算平均句长
        句长列表 = [len(句子) for 句子 in 句子列表]
        平均句长 = sum(句长列表) / len(句长列表)
        
        # 计算短句比例（句长<=15）
        短句数 = sum(1 for 长度 in 句长列表 if 长度 <= 15)
        短句比例 = 短句数 / len(句长列表)
        
        # 计算动作动词密度
        动作动词 = ["走", "跑", "跳", "打", "说", "看", "拿", "放", "打开", "关闭"]
        动作次数 = sum(文本.count(动词) for 动词 in 动作动词)
        动作密度 = 动作次数 / max(len(文本) / 100, 1)
        
        # 计算对话比例
        对话标记 = ["“", "”", "说道", "问道", "回答", "喊道"]
        对话句子数 = sum(1 for 句子 in 句子列表 if any(标记 in 句子 for 标记 in 对话标记))
        对话比例 = 对话句子数 / len(句子列表)
        
        return {
            "平均句长": 平均句长,
            "短句比例": 短句比例,
            "动作动词密度": 动作密度,
            "对话比例": 对话比例
        }
    
    def 分析词汇特征(self, 文本: str) -> Dict[str, List[str]]:
        """分析词汇特征"""
        # 提取高频词（长度>=2）
        词汇统计 = {}
        for 词 in re.findall(r'[\u4e00-\u9fa5]{2,}', 文本):
            词汇统计[词] = 词汇统计.get(词, 0) + 1
        
        # 取前20个高频词
        高频词 = sorted(词汇统计.items(), key=lambda x: x[1], reverse=True)[:20]
        
        return {
            "高频词": [词 for 词, 频次 in 高频词],
            "词汇丰富度": len(词汇统计) / max(len(文本) / 100, 1)
        }
    
    def 判断整体风格(self, 分析结果: Dict[str, Any]) -> str:
        """根据分析结果判断整体风格"""
        句式特征 = 分析结果["句式分析"]
        情感特征 = 分析结果["情感分析"]
        节奏特征 = 分析结果["节奏分析"]
        
        # 风格判断规则
        if 情感特征.get("愤怒", 0) > 0.1 and 节奏特征.get("动作动词密度", 0) > 0.2:
            return "热血战斗风"
        elif 情感特征.get("爱慕", 0) > 0.15 and 情感特征.get("悲伤", 0) > 0.1:
            return "虐心言情风"
        elif 情感特征.get("恐惧", 0) > 0.1 and 情感特征.get("惊讶", 0) > 0.1:
            return "悬疑推理风"
        elif 节奏特征.get("平均句长", 0) > 22 and 句式特征.get("描写句", 0) > 0.4:
            return "史诗奇幻风"
        elif 情感特征.get("喜悦", 0) > 0.15 and 节奏特征.get("短句比例", 0) > 0.6:
            return "轻松搞笑风"
        else:
            return "现实写实风"
    
    def 分割句子(self, 文本: str) -> List[str]:
        """分割文本为句子"""
        句子列表 = re.split(r'[。！？!?]', 文本)
        return [句子.strip() for 句子 in 句子列表 if 句子.strip()]
    
    def 生成默认分析结果(self) -> Dict[str, Any]:
        """生成默认分析结果"""
        return {
            "句式分析": {"短句": 0.5, "长句": 0.3, "对话句": 0.2},
            "情感分析": {"中性": 1.0},
            "节奏分析": {"平均句长": 20, "短句比例": 0.5, "动作动词密度": 0.2, "对话比例": 0.3},
            "词汇分析": {"高频词": [], "词汇丰富度": 1.0},
            "整体风格": "现实写实风"
        }

class 风格管理器:
    """风格管理器"""
    def __init__(self):
        self.配置管理器 = 获取配置管理器()
        self.网络学习引擎 = 获取网络学习引擎()
        self.分析器 = 风格分析器()
        self.日志器 = logging.getLogger('风格管理器')
        
        # 风格存储
        self.风格库路径 = Path("风格库")
        self.风格库路径.mkdir(exist_ok=True)
        
        self.风格市场 = {}  # 预设风格
        self.用户风格 = {}  # 用户自定义风格
        self.融合风格 = {}  # 融合风格
        self.克隆风格 = {}  # 克隆风格
        
        # 加载风格
        self.初始化风格市场()
        self.加载用户风格()
    
    def 初始化风格市场(self):
        """初始化风格市场（预设风格）"""
        self.风格市场 = {
            "热血战斗风": 风格参数(
                名称="热血战斗风",
                类型=风格类型.热血战斗风,
                描述="充满激情与热血的战斗风格，打斗场面精彩刺激",
                词汇偏好=["战斗", "热血", "激情", "胜利", "力量", "勇气", "信念"],
                句式特点={"短句": 0.7, "动作句": 0.8, "对话句": 0.5},
                情感基调={"愤怒": 0.7, "喜悦": 0.6, "惊讶": 0.5},
                节奏控制={"快节奏": 0.9, "动作密集": 0.8, "紧张感": 0.7},
                特殊规则=["多用感叹号", "动作描写详细", "心理活动突出"],
                作者影响={"金庸": 0.6, "江南": 0.4},
                创建时间=time.time(),
                修改时间=time.time(),
                使用次数=0,
                用户评分=4.5
            ),
            "虐心言情风": 风格参数(
                名称="虐心言情风",
                类型=风格类型.虐心言情风,
                描述="情感细腻虐心的言情风格，让人感动落泪",
                词汇偏好=["爱情", "心痛", "泪水", "缘分", "永恒", "错过", "遗憾"],
                句式特点={"心理句": 0.8, "对话句": 0.7, "长句": 0.6},
                情感基调={"悲伤": 0.9, "爱慕": 0.8, "喜悦": 0.3},
                节奏控制={"慢节奏": 0.8, "情感起伏": 0.9, "内心独白": 0.7},
                特殊规则=["注重心理描写", "情感转折强烈", "结局往往遗憾"],
                作者影响={"琼瑶": 0.8, "江南": 0.5},
                创建时间=time.time(),
                修改时间=time.time(),
                使用次数=0,
                用户评分=4.3
            ),
            "悬疑推理风": 风格参数(
                名称="悬疑推理风",
                类型=风格类型.悬疑推理风,
                描述="悬念设置巧妙，逻辑严密的推理风格",
                词汇偏好=["谜题", "线索", "推理", "真相", "怀疑", "证据", "犯罪"],
                句式特点={"短句": 0.6, "心理句": 0.7, "描写句": 0.5},
                情感基调={"恐惧": 0.7, "惊讶": 0.8, "沉思": 0.6},
                节奏控制={"中节奏": 0.7, "悬念设置": 0.9, "逻辑推进": 0.8},
                特殊规则=["埋设伏笔", "层层递进", "意外反转"],
                作者影响={"东野圭吾": 0.7, "阿加莎": 0.6},
                创建时间=time.time(),
                修改时间=time.time(),
                使用次数=0,
                用户评分=4.6
            ),
            "史诗奇幻风": 风格参数(
                名称="史诗奇幻风", 
                类型=风格类型.史诗奇幻风,
                描述="世界观宏大，气势磅礴的奇幻风格",
                词汇偏好=["史诗", "传奇", "命运", "世界", "英雄", "王国", "魔法"],
                句式特点={"长句": 0.8, "描写句": 0.9, "心理句": 0.5},
                情感基调={"豪迈": 0.8, "悲壮": 0.7, "惊讶": 0.6},
                节奏控制={"慢节奏": 0.7, "宏大叙事": 0.9, "细节丰富": 0.8},
                特殊规则=["注重世界观构建", "人物形象鲜明", "情节曲折复杂"],
                作者影响={"托尔金": 0.8, "金庸": 0.6},
                创建时间=time.time(),
                修改时间=time.time(),
                使用次数=0,
                用户评分=4.7
            ),
            "硬核科幻风": 风格参数(
                名称="硬核科幻风",
                类型=风格类型.硬核科幻风, 
                描述="科学严谨，想象宏大的科幻风格",
                词汇偏好=["科技", "宇宙", "时间",空间", "文明", "维度", "物理"],
                句式特点={"长句": 0.7, "描写句": 0.8, "心理句": 0.6},
                情感基调={"惊讶": 0.8, "恐惧": 0.6, "沉思": 0.9},
                节奏控制={"中节奏": 0.6, "逻辑严密": 0.9, "概念解释": 0.7},
                特殊规则=["注重科学逻辑", "概念清晰", "哲学思考"],
                作者影响={"刘慈欣": 0.9, "阿西莫夫": 0.7},
                创建时间=time.time(),
                修改时间=time.time(),
                使用次数=0,
                用户评分=4.8
            )
        }
        
        # 为所有风格类型创建基本参数
        for 风格枚举 in 风格类型:
            if 风格枚举.value not in self.风格市场:
                self.风格市场[风格枚举.value] = self.创建默认风格参数(风格枚举)
    
    def 创建默认风格参数(self, 风格枚举: 风格类型) -> 风格参数:
        """为未定义的风格类型创建默认参数"""
        return 风格参数(
            名称=风格枚举.value,
            类型=风格枚举,
            描述=f"这是{风格枚举.value}的默认描述",
            词汇偏好=[],
            句式特点={"短句": 0.5, "长句": 0.5},
            情感基调={"中性": 1.0},
            节奏控制={"中节奏": 0.5},
            特殊规则=[],
            作者影响={},
            创建时间=time.time(),
            修改时间=time.time(),
            使用次数=0,
            用户评分=4.0
        )
    
    def 加载用户风格(self):
        """加载用户自定义风格"""
        用户风格文件 = self.风格库路径 / "用户风格.json"
        if 用户风格文件.exists():
            try:
                with open(用户风格文件, 'r', encoding='utf-8') as f:
                    用户风格数据 = json.load(f)
                
                for 风格名, 风格数据 in 用户风格数据.items():
                    self.用户风格[风格名] = 风格参数(**风格数据)
                
                self.日志器.info(f"加载用户风格: {len(用户风格数据)} 个")
            except Exception as e:
                self.日志器.error(f"加载用户风格失败: {e}")
    
    def 保存用户风格(self):
        """保存用户自定义风格"""
        用户风格文件 = self.风格库路径 / "用户风格.json"
        try:
            用户风格数据 = {}
            for 风格名, 风格参数实例 in self.用户风格.items():
                用户风格数据[风格名] = 风格参数实例.__dict__
            
            with open(用户风格文件, 'w', encoding='utf-8') as f:
                json.dump(用户风格数据, f, ensure_ascii=False, indent=2)
            
            self.日志器.info("用户风格保存成功")
        except Exception as e:
            self.日志器.error(f"保存用户风格失败: {e}")
    
    def 获取所有风格(self) -> Dict[str, 风格参数]:
        """获取所有可用风格"""
        所有风格 = {}
        所有风格.update(self.风格市场)
        所有风格.update(self.用户风格)
        所有风格.update(self.融合风格)
        所有风格.update(self.克隆风格)
        return 所有风格
    
    def 获取风格(self, 风格名: str) -> Optional[风格参数]:
        """获取指定风格"""
        所有风格 = self.获取所有风格()
        return 所有风格.get(风格名)
    
    def 创建用户风格(self, 风格参数: 风格参数) -> bool:
        """创建用户自定义风格"""
        try:
            if 风格参数.名称 in self.获取所有风格():
                self.日志器.warning(f"风格已存在: {风格参数.名称}")
                return False
            
            self.用户风格[风格参数.名称] = 风格参数
            self.保存用户风格()
            
            self.日志器.info(f"创建用户风格: {风格参数.名称}")
            return True
            
        except Exception as e:
            self.日志器.error(f"创建用户风格失败: {e}")
            return False
    
    def 克隆风格(self, 源文本: str, 新风格名: str, 描述: str = "") -> Optional[风格参数]:
        """从文本克隆风格"""
        try:
            # 分析源文本风格
            分析结果 = self.分析器.分析文本风格(源文本)
            
            # 创建新风格参数
            克隆风格参数 = 风格参数(
                名称=新风格名,
                类型=风格类型(分析结果["整体风格"]),
                描述=描述 or f"从文本克隆的{分析结果['整体风格']}",
                词汇偏好=分析结果["词汇分析"]["高频词"][:10],
                句式特点=分析结果["句式分析"],
                情感基调=分析结果["情感分析"],
                节奏控制=self.分析节奏参数(分析结果["节奏分析"]),
                特殊规则=[f"基于{分析结果['整体风格']}克隆"],
                作者影响={},
                创建时间=time.time(),
                修改时间=time.time(),
                使用次数=0,
                用户评分=4.0,
                融合度=0.8  # 克隆风格融合度较低
            )
            
            self.克隆风格[新风格名] = 克隆风格参数
            self.日志器.info(f"风格克隆成功: {新风格名}")
            return 克隆风格参数
            
        except Exception as e:
            self.日志器.error(f"风格克隆失败: {e}")
            return None
    
    def 分析节奏参数(self, 节奏分析: Dict[str, float]) -> Dict[str, float]:
        """将节奏分析转换为节奏参数"""
        节奏参数 = {}
        
        # 根据平均句长判断节奏
        平均句长 = 节奏分析.get("平均句长", 20)
        if 平均句长 < 18:
            节奏参数["快节奏"] = 0.8
        elif 平均句长 > 25:
            节奏参数["慢节奏"] = 0.8
        else:
            节奏参数["中节奏"] = 0.8
        
        # 动作密度
        动作密度 = 节奏分析.get("动作动词密度", 0.2)
        节奏参数["动作密集"] = min(动作密度 * 3, 1.0)
        
        # 对话比例
        对话比例 = 节奏分析.get("对话比例", 0.3)
        节奏参数["对话密集"] = min(对话比例 * 2, 1.0)
        
        return 节奏参数
    
    def 融合风格(self, 风格名1: str, 风格名2: str, 融合风格名: str, 权重1: float = 0.5) -> Optional[风格参数]:
        """融合两种风格"""
        try:
            风格1 = self.获取风格(风格名1)
            风格2 = self.获取风格(风格名2)
            
            if not 风格1 or not 风格2:
                self.日志器.error(f"找不到指定风格: {风格名1} 或 {风格名2}")
                return None
            
            权重2 = 1.0 - 权重1
            
            # 融合词汇偏好（去重合并）
            融合词汇 = list(set(风格1.词汇偏好 + 风格2.词汇偏好))
            
            # 融合句式特点（加权平均）
            融合句式 = {}
           所有句式 = set(风格1.句式特点.keys()) | set(风格2.句式特点.keys())
            for 句式 in 所有句式:
                值1 = 风格1.句式特点.get(句式, 0)
                值2 = 风格2.句式特点.get(句式, 0)
                融合句式[句式] = 值1 * 权重1 + 值2 * 权重2
            
            # 融合情感基调
            融合情感 = {}
            所有情感 = set(风格1.情感基调.keys()) | set(风格2.情感基调.keys())
            for 情感 in 所有情感:
                值1 = 风格1.情感基调.get(情感, 0)
                值2 = 风格2.情感基调.get(情感, 0)
                融合情感[情感] = 值1 * 权重1 + 值2 * 权重2
            
            # 融合节奏控制
            融合节奏 = {}
            所有节奏 = set(风格1.节奏控制.keys()) | set(风格2.节奏控制.keys())
            for 节奏 in 所有节奏:
                值1 = 风格1.节奏控制.get(节奏, 0)
                值2 = 风格2.节奏控制.get(节奏, 0)
                融合节奏[节奏] = 值1 * 权重1 + 值2 * 权重2
            
            # 合并特殊规则
            融合规则 = list(set(风格1.特殊规则 + 风格2.特殊规则))
            
            # 融合作者影响
            融合作者 = {}
            for 作者, 权重 in 风格1.作者影响.items():
                融合作者[作者] = 权重 * 权重1
            for 作者, 权重 in 风格2.作者影响.items():
                融合作者[作者] = 融合作者.get(作者, 0) + 权重 * 权重2
            
            # 创建融合风格
            融合风格参数 = 风格参数(
                名称=融合风格名,
                类型=风格类型.现实写实风,  # 默认类型，实际应该根据融合结果判断
                描述=f"{风格1.名称}和{风格2.名称}的融合风格",
                词汇偏好=融合词汇,
                句式特点=融合句式,
                情感基调=融合情感,
                节奏控制=融合节奏,
                特殊规则=融合规则,
                作者影响=融合作者,
                创建时间=time.time(),
                修改时间=time.time(),
                使用次数=0,
                用户评分=(风格1.用户评分 * 权重1 + 风格2.用户评分 * 权重2),
                融合度=min(风格1.融合度, 风格2.融合度) * 0.9  # 融合后融合度降低
            )
            
            self.融合风格[融合风格名] = 融合风格参数
            self.日志器.info(f"风格融合成功: {融合风格名}")
            return 融合风格参数
            
        except Exception as e:
            self.日志器.error(f"风格融合失败: {e}")
            return None
    
    def 训练风格(self, 风格名: str, 训练文本: str, 用户评分: float) -> bool:
        """训练优化风格参数"""
        try:
            风格参数 = self.获取风格(风格名)
            if not 风格参数:
                return False
            
            # 分析训练文本风格
            分析结果 = self.分析器.分析文本风格(训练文本)
            
            # 根据用户评分调整学习率
            学习率 = 0.1 * 用户评分 / 5.0  # 评分越高，学习率越大
            
            # 更新风格参数（简单加权更新）
            for 句式, 权重 in 分析结果["句式分析"].items():
                当前权重 = 风格参数.句式特点.get(句式, 0)
                风格参数.句式特点[句式] = 当前权重 * (1 - 学习率) + 权重 * 学习率
            
            for 情感, 强度 in 分析结果["情感分析"].items():
                当前强度 = 风格参数.情感基调.get(情感, 0)
                风格参数.情感基调[情感] = 当前强度 * (1 - 学习率) + 强度 * 学习率
            
            # 更新词汇偏好
            新词汇 = 分析结果["词汇分析"]["高频词"][:5]
            风格参数.词汇偏好 = list(set(风格参数.词汇偏好 + 新词汇))[:15]  # 限制数量
            
            # 更新使用次数和评分
            风格参数.使用次数 += 1
            风格参数.用户评分 = (风格参数.用户评分 * (风格参数.使用次数 - 1) + 用户评分) / 风格参数.使用次数
            风格参数.修改时间 = time.time()
            
            # 保存更新
            if 风格名 in self.用户风格:
                self.保存用户风格()
            
            self.日志器.info(f"风格训练完成: {风格名}, 新评分: {风格参数.用户评分}")
            return True
            
        except Exception as e:
            self.日志器.error(f"风格训练失败: {e}")
            return False
    
    def 效果预览(self, 风格名: str, 主题: str = "测试", 字数: int = 200) -> str:
        """生成风格效果预览"""
        风格参数 = self.获取风格(风格名)
        if not 风格参数:
            return f"找不到风格: {风格名}"
        
        # 根据风格参数生成预览文本
        预览文本 = self.生成风格预览文本(风格参数, 主题, 字数)
        return 预览文本
    
    def 生成风格预览文本(self, 风格参数: 风格参数, 主题: str, 字数: int) -> str:
        """根据风格参数生成预览文本"""
        # 这里简化实现，实际应该使用更复杂的文本生成
        模板库 = {
            "热血战斗风": [
                f"面对强大的敌人，{主题}毫不退缩。",
                "热血在体内沸腾，力量源源不断涌出。",
                "这一战，必须胜利！为了信念，为了荣耀！"
            ],
            "虐心言情风": [
                f"看着{主题}远去的背影，心中涌起无尽的悲伤。",
                "泪水模糊了视线，却模糊不了心中的痛。",
                "如果时光可以倒流，我定会紧紧抓住你的手。"
            ],
            "悬疑推理风": [
                f"关于{主题}的真相，似乎隐藏着更深的秘密。",
                "每个线索都指向不同的方向，真相究竟在哪里？",
                "当最后的谜底揭开时，所有人都震惊了。"
            ],
            "史诗奇幻风": [
                f"在{主题}的传奇史诗中，英雄们书写着不朽的篇章。",
                "命运的车轮缓缓转动，整个世界的命运悬于一线。",
                "古老的预言正在应验，新时代的序幕即将拉开。"
            ]
        }
        
        # 选择适合风格的模板
        默认模板 = [f"这是关于{主题}的{风格参数.名称}风格预览。"]
        模板列表 = 模板库.get(风格参数.类型.value, 默认模板)
        
        # 组合模板生成预览
        预览文本 = ""
        while len(预览文本) < 字数 and 模板列表:
            句子 = random.choice(模板列表)
            预览文本 += 句子 + " "
        
        return 预览文本.strip()
    
    def 导出风格(self, 风格名: str, 导出路径: str) -> bool:
        """导出风格配置"""
        try:
            风格参数 = self.获取风格(风格名)
            if not 风格参数:
                return False
            
            风格数据 = 风格参数.__dict__
            with open(导出路径, 'w', encoding='utf-8') as f:
                json.dump(风格数据, f, ensure_ascii=False, indent=2)
            
            self.日志器.info(f"风格导出成功: {风格名} -> {导出路径}")
            return True
            
        except Exception as e:
            self.日志器.error(f"风格导出失败: {e}")
            return False
    
    def 导入风格(self, 导入路径: str, 新风格名: str = None) -> bool:
        """导入风格配置"""
        try:
            with open(导入路径, 'r', encoding='utf-8') as f:
                风格数据 = json.load(f)
            
            if 新风格名:
                风格数据["名称"] = 新风格名
            
            风格参数 = 风格参数(**风格数据)
            return self.创建用户风格(风格参数)
            
        except Exception as e:
            self.日志器.error(f"风格导入失败: {e}")
            return False
    
    def 获取风格推荐(self, 主题: str, 情感需求: str = "") -> List[Tuple[str, float]]:
        """根据主题和情感需求推荐风格"""
        # 简单的关键词匹配推荐
        主题关键词 = {
            "战斗": ["热血战斗风", "史诗奇幻风"],
            "爱情": ["虐心言情风", "唯美古风"], 
            "推理": ["悬疑推理风", "恐怖惊悚风"],
            "奇幻": ["史诗奇幻风", "黑暗幻想风"],
            "科幻": ["硬核科幻风", "悬疑推理风"],
            "日常": ["轻松搞笑风", "日常温馨风"]
        }
        
        推荐风格 = []
        for 关键词, 风格列表 in 主题关键词.items():
            if 关键词 in 主题:
                推荐风格.extend([(风格, 0.8) for 风格 in 风格列表])
        
        # 添加热门风格
        所有风格 = self.获取所有风格()
        热门风格 = sorted(所有风格.values(), key=lambda x: x.使用次数, reverse=True)[:3]
        推荐风格.extend([(风格.名称, 0.6) for 风格 in 热门风格])
        
        # 去重并排序
        推荐字典 = {}
        for 风格名, 分数 in 推荐风格:
            if 风格名 not in 推荐字典 or 分数 > 推荐字典[风格名]:
                推荐字典[风格名] = 分数
        
        return sorted(推荐字典.items(), key=lambda x: x[1], reverse=True)

class 风格实验室:
    """风格实验室 - 高级风格操作"""
    def __init__(self):
        self.风格管理器 = 风格管理器()
        self.日志器 = logging.getLogger('风格实验室')
    
    def 创建风格混音台(self, 基础风格: str, 调整参数: Dict[str, float]) -> Optional[风格参数]:
        """创建可调整的风格混音台"""
        try:
            基础风格参数 = self.风格管理器.获取风格(基础风格)
            if not 基础风格参数:
                return None
            
            # 复制基础风格
            混音风格 = copy.deepcopy(基础风格参数)
            混音风格.名称 = f"{基础风格}_混音版"
            混音风格.融合度 *= 0.8
            
            # 应用调整参数
            for 参数路径, 调整值 in 调整参数.items():
                self.调整风格参数(混音风格, 参数路径, 调整值)
            
            return 混音风格
            
        except Exception as e:
            self.日志器.error(f"创建风格混音台失败: {e}")
            return None
    
    def 调整风格参数(self, 风格参数: 风格参数, 参数路径: str, 调整值: float):
        """调整风格参数"""
        路径部分 = 参数路径.split('.')
        当前对象 = 风格参数
        
        for 部分 in 路径部分[:-1]:
            if hasattr(当前对象, 部分):
                当前对象 = getattr(当前对象, 部分)
            else:
                return
        
        最后部分 = 路径部分[-1]
        if hasattr(当前对象, 最后部分):
            当前值 = getattr(当前对象, 最后部分)
            if isinstance(当前值, (int, float)):
                setattr(当前对象, 最后部分, 当前值 * 调整值)
        elif isinstance(当前对象, dict) and 最后部分 in 当前对象:
            当前对象[最后部分] = 当前对象[最后部分] * 调整值
    
    def 风格DNA分析(self, 风格名: str) -> Dict[str, Any]:
        """分析风格的DNA特征"""
        风格参数 = self.风格管理器.获取风格(风格名)
        if not 风格参数:
            return {}
        
        # 计算风格特征向量
        特征向量 = {}
        
        # 句式DNA
        句式DNA = sum(风格参数.句式特点.values()) / len(风格参数.句式特点) if 风格参数.句式特点 else 0
        特征向量["句式复杂度"] = 句式DNA
        
        # 情感DNA  
        情感DNA = sum(风格参数.情感基调.values()) / len(风格参数.情感基调) if 风格参数.情感基调 else 0
        特征向量["情感强度"] = 情感DNA
        
        # 节奏DNA
        节奏DNA = sum(风格参数.节奏控制.values()) / len(风格参数.节奏控制) if 风格参数.节奏控制 else 0
        特征向量["节奏感"] = 节奏DNA
        
        # 词汇DNA
        词汇DNA = len(风格参数.词汇偏好) / 20.0  # 标准化到0-1
        特征向量["词汇丰富度"] = 词汇DNA
        
        return {
            "风格名称": 风格名,
            "特征向量": 特征向量,
            "风格类型": 风格参数.类型.value,
            "融合度": 风格参数.融合度,
            "用户评分": 风格参数.用户评分
        }
    
    def 风格演化模拟(self, 初始风格: str, 演化代数: int = 5) -> List[风格参数]:
        """模拟风格演化过程"""
        演化历史 = []
        当前风格 = self.风格管理器.获取风格(初始风格)
        
        if not 当前风格:
            return []
        
        for 代 in range(演化代数):
            演化历史.append(copy.deepcopy(当前风格))
            
            # 模拟演化：随机调整参数
            演化风格 = copy.deepcopy(当前风格)
            演化风格.名称 = f"{初始风格}_演化{代+1}"
            
            # 随机调整句式特点
            for 句式 in 演化风格.句式特点:
                调整幅度 = random.uniform(0.8, 1.2)
                演化风格.句式特点[句式] = min(演化风格.句式特点[句式] * 调整幅度, 1.0)
            
            # 随机调整情感基调
            for 情感 in 演化风格.情感基调:
                调整幅度 = random.uniform(0.8, 1.2)
                演化风格.情感基调[情感] = min(演化风格.情感基调[情感] * 调整幅度, 1.0)
            
            演化风格.融合度 *= 0.95  # 每次演化融合度降低
            当前风格 = 演化风格
        
        return 演化历史

# 风格管理系统单例
风格管理系统实例 = None

def 获取风格管理系统():
    """获取风格管理系统单例"""
    global 风格管理系统实例
    if 风格管理系统实例 is None:
        风格管理系统实例 = 风格管理器()
    return 风格管理系统实例

def 获取风格实验室():
    """获取风格实验室单例"""
    return 风格实验室()

if __name__ == "__main__":
    # 测试风格管理系统
    风格管理 = 获取风格管理系统()
    实验室 = 获取风格实验室()
    
    # 测试获取所有风格
    所有风格 = 风格管理.获取所有风格()
    print("可用风格:", list(所有风格.keys())[:5])
    
    # 测试风格预览
    预览文本 = 风格管理.效果预览("热血战斗风", "英雄的战斗", 100)
    print("风格预览:", 预览文本)
    
    # 测试风格DNA分析
    DNA分析 = 实验室.风格DNA分析("热血战斗风")
    print("风格DNA分析:", DNA分析)
    
    # 测试风格推荐
    推荐 = 风格管理.获取风格推荐("爱情故事")
    print("风格推荐:", 推荐)